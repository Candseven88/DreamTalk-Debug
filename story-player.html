<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Player - DreamTalk Box</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #fcf2f7;
            color: #5a3d5c;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #e86ed0;
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        
        .logo i {
            margin-right: 10px;
        }
        
        .back-button {
            background-color: transparent;
            border: none;
            color: #9d7e9f;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            color: #5a3d5c;
            transform: translateX(-5px);
        }
        
        .back-button i {
            margin-right: 8px;
        }
        
        .story-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            margin-bottom: 40px;
        }
        
        .story-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            width: 100%;
        }
        
        .story-image {
            width: 250px;
            height: 250px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(232, 110, 208, 0.2);
        }
        
        .story-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .story-title {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 10px;
            color: #5a3d5c;
        }
        
        .story-meta {
            display: flex;
            align-items: center;
            color: #9d7e9f;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .story-meta span {
            margin: 0 10px;
        }
        
        .story-meta i {
            margin-right: 5px;
        }
        
        .story-content {
            width: 100%;
            max-width: 700px;
            line-height: 1.8;
            color: #5a3d5c;
            font-size: 1.1rem;
            margin-bottom: 40px;
            padding: 0 20px;
        }
        
        .story-content p {
            margin-bottom: 20px;
        }
        
        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }
        
        .voice-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            width: 100%;
        }
        
        .voice-option {
            flex: 1;
            padding: 12px;
            border-radius: 50px;
            border: 2px solid #e0e0e0;
            background-color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 200px;
        }
        
        .voice-option i {
            margin-right: 8px;
        }
        
        .voice-option.active {
            border-color: #e86ed0;
            background-color: #fcf2f7;
            color: #e86ed0;
        }
        
        .voice-option:hover:not(.active) {
            border-color: #a1d2ce;
            color: #a1d2ce;
        }
        
        #status {
            text-align: center;
            color: #9d7e9f;
            margin: 20px 0;
            min-height: 24px;
            font-style: italic;
        }
        
        #story-audio {
            width: 100%;
            max-width: 500px;
            margin: 20px auto;
            display: none;
        }
        
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(232, 110, 208, 0.2);
            border-radius: 50%;
            border-top-color: #e86ed0;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .more-stories {
            text-align: center;
            margin-top: 40px;
        }
        
        .more-stories h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #5a3d5c;
        }
        
        .story-suggestions {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 30px;
        }
        
        .story-suggestion {
            min-width: 200px;
            background-color: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .story-suggestion:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-image {
            height: 120px;
            overflow: hidden;
        }
        
        .suggestion-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .suggestion-title {
            padding: 15px;
            font-size: 1rem;
            color: #5a3d5c;
            text-align: center;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 50px;
            border: none;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn i {
            margin-right: 8px;
        }
        
        .btn-secondary {
            background-color: #a1d2ce;
            color: #3a6f6a;
        }
        
        .btn-secondary:hover {
            background-color: #8bc4bf;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(161, 210, 206, 0.3);
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: #9d7e9f;
            font-size: 0.9rem;
            background-color: white;
            margin-top: auto;
        }
        
        @media (max-width: 768px) {
            .story-container {
                padding: 30px 20px;
            }
            
            .story-image {
                width: 200px;
                height: 200px;
            }
            
            .story-title {
                font-size: 1.8rem;
            }
            
            .story-content {
                font-size: 1rem;
                padding: 0;
            }
            
            .voice-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .voice-option {
                width: 100%;
                max-width: 250px;
            }
            
            .story-suggestions {
                gap: 15px;
            }
            
            .story-suggestion {
                min-width: 160px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="back-button" onclick="location.href='story-library.html'">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <a href="index.html" class="logo">
                <i class="fas fa-moon"></i> DreamTalk Box
            </a>
            <!-- 添加用户登录区域 -->
            <div id="user-auth-container" style="width: 100px; text-align: right;">
                <button id="login-button" class="auth-button">Login</button>
                <div id="user-info" style="display: none;">
                    <span id="user-greeting"></span>
                    <button id="logout-button" class="auth-button">Logout</button>
                </div>
            </div>
        </header>
        
        <div class="story-container">
            <div class="story-header">
                <div class="story-image">
                    <img id="story-cover" src="https://images.unsplash.com/photo-1527409335569-f0e5c91fa707?ixlib=rb-1.2.1&auto=format&fit=crop&w=1050&q=80" alt="Story Cover">
                </div>
                <h1 id="story-title" class="story-title">Loading Story...</h1>
                <div class="story-meta">
                    <span><i class="fas fa-clock"></i> <span id="read-time">5 min read</span></span>
                    <span><i class="fas fa-child"></i> <span id="age-range">Ages 2-5</span></span>
                </div>
            </div>
            
            <div id="story-content" class="story-content">
                <p>Loading story content...</p>
            </div>
            
            <div class="player-controls">
                <div class="voice-selector">
                    <button class="voice-option" id="default-voice" onclick="playWithVoice('default')">
                        <i class="fas fa-volume-up"></i> Default Voice
                    </button>
                    <button class="voice-option" id="custom-voice" onclick="playWithVoice('custom')">
                        <i class="fas fa-user"></i> Your Voice
                    </button>
                </div>
                
                <p id="status"></p>
                <div id="loading-spinner" class="loading-spinner"></div>
                <audio id="story-audio" controls></audio>
            </div>
        </div>
        
        <div class="more-stories">
            <h3>More Stories You Might Like</h3>
            <div id="story-suggestions" class="story-suggestions">
                <!-- Story suggestions will be loaded dynamically -->
            </div>
            
            <a href="story-library.html" class="btn btn-secondary">
                <i class="fas fa-book"></i> Browse All Stories
            </a>
        </div>
    </div>
    
    <footer>
        <p>© 2023 DreamTalk Box. All rights reserved.</p>
    </footer>
    
    <script>
        // 添加获取用户订阅信息的函数
function fetchUserSubscription(email) {
    if (!email) return;
    
    fetch(`/api/user-plan?email=${encodeURIComponent(email)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch subscription data');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.userPlan) {
                // 获取当前用户信息
                const userJson = localStorage.getItem('user');
                if (userJson) {
                    const user = JSON.parse(userJson);
                    
                    // 只有当订阅计划不同时才更新
                    if (user.userPlan !== data.userPlan) {
                        user.userPlan = data.userPlan;
                        localStorage.setItem('user', JSON.stringify(user));
                        console.log(`Updated user subscription to: ${data.userPlan}`);
                        
                        // 更新界面显示
                        updateUserInterface();
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error fetching subscription:', error);
            // 失败时保持原有订阅计划，不做任何更改
        });
}
        // Global variables
        let currentStory = null;
        let allStories = [];
        
        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadStoryFromUrl();
        });
        
        /**
         * Extract story ID from URL parameters and load the story
         */
        async function loadStoryFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const storyId = urlParams.get('id');
            
            if (!storyId) {
                showError("No story ID provided");
                return;
            }
            
            // 首先检查是否为用户上传的故事 (通常以 "story_" 开头)
            if (storyId.startsWith('story_')) {
                // 从 localStorage 中读取用户故事
                const userStories = JSON.parse(localStorage.getItem('userStories')) || [];
                const userStory = userStories.find(story => story.id === storyId);
                
                if (userStory) {
                    // 找到用户故事，加载内容
                    displayStory(userStory);
                } else {
                    showError("User story not found");
                }
            } else {
                // 尝试从系统故事中加载
                fetch('stories.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(stories => {
                        const story = stories.find(s => s.id === storyId);
                        
                        if (story) {
                            displayStory(story);
                        } else {
                            // 如果系统故事中找不到，再次尝试从用户故事中查找
                            const userStories = JSON.parse(localStorage.getItem('userStories')) || [];
                            const userStory = userStories.find(s => s.id === storyId);
                            
                            if (userStory) {
                                displayStory(userStory);
                            } else {
                                showError("Story not found");
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading story:', error);
                        
                        // 如果系统故事加载失败，尝试从用户故事中查找
                        try {
                            const userStories = JSON.parse(localStorage.getItem('userStories')) || [];
                            const userStory = userStories.find(s => s.id === storyId);
                            
                            if (userStory) {
                                displayStory(userStory);
                            } else {
                                showError("Failed to load story");
                            }
                        } catch (e) {
                            showError("Failed to load story");
                        }
                    });
            }
        }
        
        /**
         * Load a system story from stories.json
         * @param {string} storyId - The ID of the story to load
         */
        async function loadSystemStory(storyId) {
            try {
                updateStatus('Loading story...');
                
                // Fetch stories.json
                const response = await fetch('stories.json');
                if (!response.ok) {
                    throw new Error(`Failed to fetch stories: ${response.status}`);
                }
                
                const stories = await response.json();
                allStories = stories; // Save for suggestions
                
                // Find the story with matching ID
                const story = stories.find(s => s.id === storyId);
                
                if (!story) {
                    throw new Error('Story not found');
                }
                
                // Display the story
                displayStory(story);
                
                // Load story suggestions
                loadStorySuggestions(storyId);
                
            } catch (error) {
                console.error('Error loading system story:', error);
                updateStatus(`Error: ${error.message}`);
            }
        }
        
        /**
         * Load a user story from localStorage
         * @param {string} storyId - The ID of the user story to load
         */
        function loadUserStory(storyId) {
            try {
                updateStatus('Loading your story...');
                
                // Get user stories from localStorage
                const userStories = JSON.parse(localStorage.getItem('userStories')) || [];
                
                // Find the story with matching ID
                const story = userStories.find(s => s.id === storyId);
                
                if (!story) {
                    throw new Error('Your story was not found');
                }
                
                // Display the story
                displayStory(story);
                
                // Load system stories for suggestions
                loadSystemStoriesForSuggestions();
                
            } catch (error) {
                console.error('Error loading user story:', error);
                updateStatus(`Error: ${error.message}`);
            }
        }
        
        /**
         * Display a story on the page
         * @param {Object} story - The story object to display
         */
        function displayStory(story) {
            currentStory = story;
            
            // Update story title
            document.getElementById('story-title').textContent = story.title;
            
            // Update story content
            const storyContent = document.getElementById('story-content');
            
            // Clear existing content
            storyContent.innerHTML = '';
            
            // Format story content into paragraphs
            const paragraphs = story.content.split('\n\n');
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    const p = document.createElement('p');
                    p.textContent = paragraph.trim();
                    storyContent.appendChild(p);
                }
            });
            
            // 更新封面图片处理逻辑 - 修复各种图片路径类型
            let coverImage = story.cover || story.coverImage || '/covers/default.jpg';
            if (
                coverImage &&
                !coverImage.startsWith('http') &&
                !coverImage.startsWith('https') &&
                !coverImage.startsWith('data:') &&
                !coverImage.startsWith('/')
            ) {
                coverImage = '/' + coverImage;
            }
            const coverImg = document.getElementById('story-cover');
            coverImg.src = coverImage;
            coverImg.alt = story.title;
            coverImg.onerror = () => {
                coverImg.src = '/covers/default.jpg';
            };
            
            // Update story metadata
            document.getElementById('read-time').textContent = `${Math.ceil(story.content.length / 1000)} min read`;
            document.getElementById('age-range').textContent = story.ageRange || 'Ages 2-5';
            
            // Show story container and hide loading indicator
            document.getElementById('story-container').style.display = 'block';
            document.getElementById('loading-indicator').style.display = 'none';
            
            // Update page title
            document.title = `${story.title} - DreamTalk Box`;
            
            // Load story suggestions
            loadStorySuggestions(story.id);
        }
        
        /**
         * Update the status message
         * @param {string} message - The status message to display
         */
        function updateStatus(message) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            
            // Show/hide loading spinner
            const spinner = document.getElementById('loading-spinner');
            if (message.includes('Loading') || message.includes('Generating')) {
                spinner.style.display = 'block';
            } else {
                spinner.style.display = 'none';
            }
        }
        
        /**
         * Play the story with the specified voice type
         * @param {string} mode - The voice mode ('default' or 'custom')
         */
        async function playWithVoice(mode) {
            // 检查订阅限制
            if (!checkSubscriptionLimits()) {
                return; // 如果超出限制，直接返回
            }
            
            // 增加播放次数
            incrementPlayCount();
            
            // 获取音频元素和状态显示
            const audioElement = document.getElementById('story-audio');
            
            // Get the button elements
            const defaultVoiceBtn = document.getElementById('default-voice');
            const customVoiceBtn = document.getElementById('custom-voice');
            
            // Store original button text
            const originalText = mode === 'default' ? 
                defaultVoiceBtn.innerHTML : 
                customVoiceBtn.innerHTML;
            
            // Disable both buttons and show synthesizing state
            defaultVoiceBtn.disabled = true;
            customVoiceBtn.disabled = true;
            
            // Change the clicked button text to show processing
            if (mode === 'default') {
                defaultVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synthesizing...';
            } else {
                customVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synthesizing...';
            }
            
            // Hide audio player until audio is ready
            audioElement.style.display = 'none';
            
            // Check if story content is available
            if (!currentStory || !currentStory.content) {
                updateStatus('Error: No story content available');
                resetButtons(mode, originalText);
                alert("Voice playback failed. Please try again later.");
                return;
            }
            
            const text = currentStory.content;
            
            // Determine which voice ID to use
            let voiceId;
            if (mode === 'default') {
                voiceId = '39TvLx60dsfus7kWDYn1'; // System default voice_id
                updateStatus('Generating audio with default voice...');
            } else if (mode === 'custom') {
                voiceId = localStorage.getItem('voice_id');
                if (!voiceId) {
                    updateStatus('Error: No custom voice found. Please record your voice first.');
                    resetButtons(mode, originalText);
                    alert("No custom voice found. Please record your voice first.");
                    return;
                }
                updateStatus('Generating audio with your voice...');
            } else {
                updateStatus('Error: Invalid voice mode');
                resetButtons(mode, originalText);
                alert("Voice playback failed. Please try again later.");
                return;
            }
            
            // Update UI to show active voice option
            defaultVoiceBtn.classList.toggle('active', mode === 'default');
            customVoiceBtn.classList.toggle('active', mode === 'custom');
            
            try {
                // Call ElevenLabs API
                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/' + voiceId, {
                    method: 'POST',
                    headers: {
                        'Accept': 'audio/mpeg',
                        'Content-Type': 'application/json',
                        'xi-api-key': 'YOUR_API_KEY' // Replace with your actual API key
                    },
                    body: JSON.stringify({
                        text: text,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.75
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                // Get audio blob
                const audioBlob = await response.blob();
                
                // Create object URL for audio
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Set audio source and play
                audioElement.src = audioUrl;
                audioElement.style.display = 'block';
                
                // Play audio
                audioElement.play()
                    .then(() => {
                        updateStatus('Playing story...');
                    })
                    .catch(error => {
                        console.error('Error playing audio:', error);
                        updateStatus('Error playing audio');
                        alert("Voice playback failed. Please try again later.");
                    })
                    .finally(() => {
                        // Reset buttons regardless of play success
                        resetButtons(mode, originalText);
                    });
                
                // Add event listener for when audio ends
                audioElement.onended = function() {
                    updateStatus('Playback complete');
                    resetButtons(mode, originalText);
                };
                
            } catch (error) {
                console.error('Error generating audio:', error);
                updateStatus(`Error: ${error.message}`);
                resetButtons(mode, originalText);
                alert("Voice playback failed. Please try again later.");
            }
        }
        
        /**
         * Reset button states after playback or error
         * @param {string} mode - The voice mode ('default' or 'custom')
         * @param {string} originalText - The original button text
         */
        function resetButtons(mode, originalText) {
            const defaultVoiceBtn = document.getElementById('default-voice');
            const customVoiceBtn = document.getElementById('custom-voice');
            
            // Re-enable both buttons
            defaultVoiceBtn.disabled = false;
            customVoiceBtn.disabled = false;
            
            // Restore original button text
            if (mode === 'default') {
                defaultVoiceBtn.innerHTML = originalText;
            } else {
                customVoiceBtn.innerHTML = originalText;
            }
        }
        /**
 * Log story playback event
 * @param {string} mode - The voice mode ('default' or 'custom')
 */
/**
 * Log story playback event
 * @param {string} mode - The voice mode ('default' or 'custom')
 */
 function logPlaybackEvent(mode) {
    try {
        // Get current timestamp
        const timestamp = Math.floor(Date.now() / 1000);
        
        // Get user information
        const user = JSON.parse(localStorage.getItem('user'));
        const anonymousUID = localStorage.getItem('anonymousUID');
        
        // 确定来源页面
        let sourcePage = "unknown";
        const currentPath = window.location.pathname;
        if (currentPath.includes("index")) {
            sourcePage = "index";
        } else if (currentPath.includes("library")) {
            sourcePage = "library";
        } else if (currentPath.includes("my-stories")) {
            sourcePage = "my-stories";
        } else if (currentPath.includes("story-player")) {
            sourcePage = "player";
        }
        
        // 检查是否为移动设备
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // Prepare log data with enhanced fields
        const logData = {
            // User identifier (email if logged in, anonymousUID if not)
            email: user ? user.email : anonymousUID,
            // Subscription plan
            plan: user ? user.userPlan : 'free',
            // Story ID
            storyId: currentStory ? currentStory.id : 'unknown',
            // Voice type
            voice: mode === 'default' ? 'default' : 'user',
            // Timestamp
            ts: timestamp,
            // 新增：来源页面
            sourcePage: sourcePage,
            // 新增：设备类型
            isMobile: isMobile,
            // 新增：默认动作
            action: 'play'
        };
        
        // 记录播放开始时间用于计算时长
        localStorage.setItem('playback_start_time', timestamp.toString());
        
        // Store log in localStorage for debugging
        const playbackLogs = JSON.parse(localStorage.getItem('playbackLogs') || '[]');
        playbackLogs.push(logData);
        localStorage.setItem('playbackLogs', JSON.stringify(playbackLogs));
        
        // Send log to API endpoint
        fetch('/api/logs.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(logData)
        })
        .then(response => {
            if (!response.ok) {
                console.warn('Failed to send playback log to server:', response.status);
            } else {
                console.log('Playback log sent to server successfully');
            }
        })
        .catch(error => {
            console.error('Error sending playback log to server:', error);
        });
        
        console.log('Playback event logged:', logData);
    } catch (error) {
        console.error('Error logging playback event:', error);
    }
}
/**
 * Log playback completion with duration
 */
 function logPlaybackCompletion() {
    try {
        const startTime = parseInt(localStorage.getItem('playback_start_time') || '0');
        if (startTime === 0) return;
        
        const endTime = Math.floor(Date.now() / 1000);
        const duration = endTime - startTime;
        
        // Get user information
        const user = JSON.parse(localStorage.getItem('user'));
        const anonymousUID = localStorage.getItem('anonymousUID');
        
        // Prepare completion log data
        const logData = {
            email: user ? user.email : anonymousUID,
            plan: user ? user.userPlan : 'free',
            storyId: currentStory ? currentStory.id : 'unknown',
            ts: endTime,
            duration: duration,
            action: 'complete'
        };
        
        // Send completion log to API
        fetch('/api/logs.js', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(logData)
        })
        .then(response => {
            if (!response.ok) {
                console.warn('Failed to send completion log to server:', response.status);
            } else {
                console.log('Playback completion logged successfully');
            }
        })
        .catch(error => {
            console.error('Error sending completion log to server:', error);
        });
        
        // Clear start time
        localStorage.removeItem('playback_start_time');
        
    } catch (error) {
        console.error('Error logging playback completion:', error);
    }
}
    </script>
</body>
</html>

<style>
    /* 订阅弹窗样式 */
#subscription-modal .modal-content {
    text-align: center;
    max-width: 450px;
}

#subscription-modal h2 {
    color: #e86ed0;
    margin-bottom: 20px;
}

#subscription-modal p {
    margin-bottom: 15px;
    color: #5a3d5c;
    font-size: 1.1rem;
}

#subscription-modal .btn-primary {
    background-color: #e86ed0;
    margin-top: 20px;
    max-width: 200px;
    display: inline-block;
}

#subscription-modal .btn-primary:hover {
    background-color: #d55bbe;
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(232, 110, 208, 0.3);
}
    /* 在现有样式后添加 */
    .auth-button {
        background-color: #a1d2ce;
        color: #3a6f6a;
        border: none;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .auth-button:hover {
        background-color: #8bc4bf;
    }
    
    #user-greeting {
        display: block;
        font-size: 0.8rem;
        color: #5a3d5c;
        margin-bottom: 5px;
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        position: relative;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #9d7e9f;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #5a3d5c;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
    }
    
    .btn-primary {
        background-color: #e86ed0;
        color: white;
        border: none;
        border-radius: 50px;
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
    }
    
    .btn-primary:hover {
        background-color: #d55bbe;
    }
</style>

<!-- 在 body 结束标签前添加登录模态框 -->
<div id="login-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h2>Login to DreamTalk Box</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="nickname">Nickname:</label>
                <input type="text" id="nickname" required>
            </div>
            <div class="form-group">
                <label for="subscription">Subscription Plan:</label>
                <select id="subscription">
                    <option value="free">Free</option>
                    <option value="starter">Starter</option>
                    <option value="plus">Plus</option>
                    <option value="pro">Pro</option>
                </select>
            </div>
            <button type="submit" class="btn-primary">Login</button>
        </form>
    </div>
</div>

<script>
    // 在现有脚本后添加
    
    // 生成 UUID 函数
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    // 初始化匿名用户 ID
    function initAnonymousUser() {
        // 检查用户是否已登录
        const user = JSON.parse(localStorage.getItem('user'));
        if (user) {
            console.log('User is logged in, using user ID instead of anonymous ID');
            return;
        }
        
        // 检查是否已有匿名 ID
        let anonymousUID = localStorage.getItem('anonymousUID');
        if (!anonymousUID) {
            // 生成新的匿名 ID
            anonymousUID = generateUUID();
            localStorage.setItem('anonymousUID', anonymousUID);
            console.log('Generated new anonymous UID:', anonymousUID);
            
            // 初始化播放次数
            localStorage.setItem(`playCount_${anonymousUID}`, '0');
        } else {
            console.log('Using existing anonymous UID:', anonymousUID);
        }
    }
    
    // 检查用户订阅限制
    // 检查用户订阅限制
function checkSubscriptionLimits() {
    // 检查用户是否已登录
    const user = JSON.parse(localStorage.getItem('user'));
    
    let userPlan = 'free';
    let playCount = 0;
    let maxPlays = 5;
    let maxLength = 3;
    
    if (user) {
        // 已登录用户 - 使用用户订阅计划
        userPlan = user.userPlan || 'free';
        playCount = parseInt(localStorage.getItem(`playCount_${user.email}`) || '0');
        
        // 根据订阅等级设置限制
        if (userPlan === 'starter') {
            maxPlays = 30;
            maxLength = 90;
        } else if (userPlan === 'plus') {
            maxPlays = 100;
            maxLength = 300;
        } else if (userPlan === 'pro') {
            maxPlays = 300;
            maxLength = 900;
        }
        
        console.log(`Logged in user: ${user.nickname}, Plan: ${userPlan}, Plays: ${playCount}/${maxPlays}`);
    } else {
        // 匿名用户 - 使用匿名 ID
        const anonymousUID = localStorage.getItem('anonymousUID');
        if (!anonymousUID) {
            console.error('No anonymous UID found');
            return false;
        }
        
        playCount = parseInt(localStorage.getItem(`playCount_${anonymousUID}`) || '0');
        console.log(`Anonymous user: ${anonymousUID}, Plays: ${playCount}/${maxPlays}`);
    }
    
    // 获取故事时长（分钟）- 假设每1000字约1分钟
    const storyLength = currentStory ? Math.ceil(currentStory.content.length / 1000) : 0;
    
    // 检查是否超出故事数量限制
    if (playCount >= maxPlays) {
        // 显示订阅提示弹窗，而不是简单的 alert
        showSubscriptionModal('count');
        return false;
    }
    
    // 检查故事时长是否超出限制
    if (storyLength > maxLength) {
        // 显示订阅提示弹窗，而不是简单的 alert
        showSubscriptionModal('length');
        return false;
    }
    
    return true;
}
    
    // 增加播放次数
    function incrementPlayCount() {
        const user = JSON.parse(localStorage.getItem('user'));
        
        if (user) {
            // 已登录用户 - 使用用户邮箱作为标识
            let playCount = parseInt(localStorage.getItem(`playCount_${user.email}`) || '0');
            playCount++;
            localStorage.setItem(`playCount_${user.email}`, playCount.toString());
            console.log(`Incremented play count for user ${user.nickname} to ${playCount}`);
        } else {
            // 匿名用户 - 使用匿名 ID
            const anonymousUID = localStorage.getItem('anonymousUID');
            if (!anonymousUID) {
                console.error('No anonymous UID found');
                return;
            }
            
            let playCount = parseInt(localStorage.getItem(`playCount_${anonymousUID}`) || '0');
            playCount++;
            localStorage.setItem(`playCount_${anonymousUID}`, playCount.toString());
            console.log(`Incremented play count for anonymous user to ${playCount}`);
        }
    }
    
    // 检查并重置每月播放次数
    function checkAndResetMonthlyPlayCount() {
        const lastResetDate = localStorage.getItem('lastPlayCountReset');
        const currentDate = new Date();
        
        // 如果没有重置日期或者当前月份与上次重置月份不同
        if (!lastResetDate || new Date(lastResetDate).getMonth() !== currentDate.getMonth()) {
            // 重置所有播放计数
            const keys = Object.keys(localStorage);
            for (let key of keys) {
                if (key.startsWith('playCount_')) {
                    localStorage.setItem(key, '0');
                }
            }
            
            localStorage.setItem('lastPlayCountReset', currentDate.toString());
            console.log('Monthly play counts have been reset');
        }
    }
    
    // 更新用户界面显示
    function updateUserInterface() {
        const user = JSON.parse(localStorage.getItem('user'));
        const loginButton = document.getElementById('login-button');
        const userInfo = document.getElementById('user-info');
        const userGreeting = document.getElementById('user-greeting');
        
        if (user) {
            // 用户已登录 - 显示用户信息
            loginButton.style.display = 'none';
            userInfo.style.display = 'block';
            userGreeting.textContent = `Hi, ${user.nickname}! [${user.userPlan.charAt(0).toUpperCase() + user.userPlan.slice(1)}]`;
        } else {
            // 用户未登录 - 显示登录按钮
            loginButton.style.display = 'block';
            userInfo.style.display = 'none';
        }
        function updateUserInterface() {
    const user = JSON.parse(localStorage.getItem('user'));
    const loginButton = document.getElementById('login-button');
    const userInfo = document.getElementById('user-info');
    const userGreeting = document.getElementById('user-greeting');
    
    if (user) {
        // 用户已登录 - 显示用户信息
        loginButton.style.display = 'none';
        userInfo.style.display = 'block';
        userGreeting.textContent = `Hi, ${user.nickname}! [${user.userPlan.charAt(0).toUpperCase() + user.userPlan.slice(1)}]`;
        
        // 新增：如果用户已登录，检查订阅状态
        fetchUserSubscription(user.email);
    } else {
        // 用户未登录 - 显示登录按钮
        loginButton.style.display = 'block';
        userInfo.style.display = 'none';
    }
}
    }
    
    // 登录功能
    function setupLoginSystem() {
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const closeModal = document.querySelector('.close-modal');
        const loginForm = document.getElementById('login-form');
        
        // 打开登录模态框
        loginButton.addEventListener('click', function() {
            loginModal.style.display = 'flex';
        });
        
        // 关闭登录模态框
        closeModal.addEventListener('click', function() {
            loginModal.style.display = 'none';
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target === loginModal) {
                loginModal.style.display = 'none';
            }
        });
        
        // 处理登录表单提交
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const nickname = document.getElementById('nickname').value;
            const userPlan = document.getElementById('subscription').value;
            
            // 创建用户对象
            const user = {
                email: email,
                nickname: nickname,
                userPlan: userPlan
            };
            
            // 保存用户信息
            localStorage.setItem('user', JSON.stringify(user));
            
            // 初始化用户播放次数（如果不存在）
            if (!localStorage.getItem(`playCount_${email}`)) {
                localStorage.setItem(`playCount_${email}`, '0');
            }
            
            // 更新界面
            updateUserInterface();
            
            // 关闭模态框
            loginModal.style.display = 'none';
            
            console.log(`User logged in: ${nickname} (${email}) with ${userPlan} plan`);
        });
        
        // 处理退出登录
        logoutButton.addEventListener('click', function() {
            // 清除用户信息
            localStorage.removeItem('user');
            
            // 更新界面
            updateUserInterface();
            
            console.log('User logged out');
        });
        // 处理登录表单提交
loginForm.addEventListener('submit', function(event) {
    // ... 现有代码 ...
    
    // 关闭模态框
    loginModal.style.display = 'none';
    
    console.log(`User logged in: ${nickname} (${email}) with ${userPlan} plan`);
    
    // 新增：获取用户的实际订阅信息
    fetchUserSubscription(email);
});
    }
    
    // 修改 playWithVoice 函数，添加订阅检查
    async function playWithVoice(mode) {
        // 记录播放事件
    logPlaybackEvent(mode);
    
    // 检查订阅限制
    if (!checkSubscriptionLimits()) {
        return; // 如果超出限制，直接返回
    }
    
    // 增加播放次数
    incrementPlayCount();
        
        // 检查订阅限制
        if (!checkSubscriptionLimits()) {
            return; // 如果超出限制，直接返回
        }
        
        // 增加播放次数
        incrementPlayCount();
        
        // 获取音频元素和状态显示
        const audioElement = document.getElementById('story-audio');
        
        // 获取按钮元素
        const defaultVoiceBtn = document.getElementById('default-voice');
        const customVoiceBtn = document.getElementById('custom-voice');
        
        // 存储原始按钮文本
        const originalText = mode === 'default' ? 
            defaultVoiceBtn.innerHTML : 
            customVoiceBtn.innerHTML;
        
        // 禁用两个按钮并显示合成状态
        defaultVoiceBtn.disabled = true;
        customVoiceBtn.disabled = true;
        
        // 更改点击的按钮文本以显示处理中
        if (mode === 'default') {
            defaultVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synthesizing...';
        } else {
            customVoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Synthesizing...';
        }
        
        // 隐藏音频播放器，直到音频准备就绪
        audioElement.style.display = 'none';
        
        // 检查故事内容是否可用
        if (!currentStory || !currentStory.content) {
            updateStatus('Error: No story content available');
            resetButtons(mode, originalText);
            alert("Voice playback failed. Please try again later.");
            return;
        }
        
        const text = currentStory.content;
        
        // 确定使用哪个语音 ID
        let voiceId;
        if (mode === 'default') {
            voiceId = '39TvLx60dsfus7kWDYn1'; // 系统默认 voice_id
            updateStatus('Generating audio with default voice...');
        } else if (mode === 'custom') {
            voiceId = localStorage.getItem('voice_id');
            if (!voiceId) {
                updateStatus('Error: No custom voice found. Please record your voice first.');
                resetButtons(mode, originalText);
                alert("No custom voice found. Please record your voice first.");
                return;
            }
            updateStatus('Generating audio with your voice...');
        } else {
            updateStatus('Error: Invalid voice mode');
            resetButtons(mode, originalText);
            alert("Voice playback failed. Please try again later.");
            return;
        }
        
        // 更新 UI 以显示活动语音选项
        defaultVoiceBtn.classList.toggle('active', mode === 'default');
        customVoiceBtn.classList.toggle('active', mode === 'custom');
        
        try {
            // 调用 ElevenLabs API
            const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/' + voiceId, {
                method: 'POST',
                headers: {
                    'Accept': 'audio/mpeg',
                    'Content-Type': 'application/json',
                    'xi-api-key': 'YOUR_API_KEY' // 替换为您的实际 API 密钥
                },
                body: JSON.stringify({
                    text: text,
                    model_id: 'eleven_monolingual_v1',
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.75
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            // 获取音频 blob
            const audioBlob = await response.blob();
            
            // 创建音频 URL
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // 设置音频源并播放
            audioElement.src = audioUrl;
            audioElement.style.display = 'block';
            
            // 播放音频
            audioElement.play()
                .then(() => {
                    updateStatus('Playing story...');
                })
                .catch(error => {
                    console.error('Error playing audio:', error);
                    updateStatus('Error playing audio');
                    alert("Voice playback failed. Please try again later.");
                })
                .finally(() => {
                    // 无论播放是否成功，都重置按钮
                    resetButtons(mode, originalText);
                });
            
           // 添加音频结束时的事件监听器
audioElement.onended = function() {
    updateStatus('Playback complete');
    resetButtons(mode, originalText);
    // 添加：记录播放完成事件
    logPlaybackCompletion();
};
            
        } catch (error) {
            console.error('Error generating audio:', error);
            updateStatus(`Error: ${error.message}`);
            resetButtons(mode, originalText);
            alert("Voice playback failed. Please try again later.");
        }
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化匿名用户
        initAnonymousUser();
        
        // 检查并重置每月播放次数
        checkAndResetMonthlyPlayCount();
        
        // 设置登录系统
        setupLoginSystem();
        
        // 更新用户界面
        updateUserInterface();
        
        // 加载故事
        loadStoryFromUrl();
    });
    // 添加订阅弹窗控制函数
function showSubscriptionModal(reason) {
    const modal = document.getElementById('subscription-modal');
    const modalContent = modal.querySelector('.modal-content');
    const messageParagraph = modalContent.querySelector('p:nth-child(3)');
    
    // 根据原因自定义消息
    if (reason === 'count') {
        messageParagraph.textContent = 'Upgrade your subscription to enjoy more stories this month!';
    } else if (reason === 'length') {
        messageParagraph.textContent = 'Upgrade your subscription to access longer stories!';
    } else {
        messageParagraph.textContent = 'Upgrade your subscription to unlock more stories and features!';
    }
    
    // 显示弹窗
    modal.style.display = 'flex';
}

function closeSubscriptionModal() {
    const modal = document.getElementById('subscription-modal');
    modal.style.display = 'none';
}

function redirectToSubscription() {
    // 跳转到首页的订阅区域
    window.location.href = 'index.html#subscription-section';
}

// 添加点击模态框外部关闭的事件监听
window.addEventListener('click', function(event) {
    const subscriptionModal = document.getElementById('subscription-modal');
    if (event.target === subscriptionModal) {
        closeSubscriptionModal();
    }
});
</script>
<!-- 添加订阅提示弹窗 -->
<div id="subscription-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal" onclick="closeSubscriptionModal()">&times;</span>
        <h2>Subscription Limit Reached</h2>
        <p>You have reached the playback limit for your current subscription plan.</p>
        <p>Upgrade your subscription to unlock more stories and features!</p>
        <button onclick="redirectToSubscription()" class="btn-primary">Subscribe Now</button>
    </div>
</div>